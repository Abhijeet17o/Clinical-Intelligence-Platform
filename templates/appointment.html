<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment - {{ patient.full_name }} - EHR System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 2em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .header-left p {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .back-link {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .back-link::before {
            content: '‚Üê ';
        }
        
        .content {
            padding: 30px 40px;
        }
        
        .layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }
        
        /* Left Column - Patient Info */
        .patient-info-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 25px;
            border-left: 5px solid #667eea;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .patient-detail {
            margin-bottom: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
        }
        
        .patient-detail label {
            display: block;
            font-weight: bold;
            color: #667eea;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .patient-detail-value {
            color: #333;
            font-size: 1.1em;
        }
        
        .ehr-data-section {
            margin-top: 25px;
            background: white;
            border-radius: 8px;
            padding: 15px;
        }
        
        .ehr-data-section h3 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 10px;
        }
        
        .ehr-content {
            background: #f9f9f9;
            border: 2px dashed #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #666;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ehr-empty {
            text-align: center;
            color: #999;
            font-style: italic;
        }
        
        /* Right Column - Consultation & Prescription */
        .main-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .card {
            background: #f9f9f9;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e0e0e0;
        }
        
        .consultation-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .recording-btn {
            padding: 20px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .btn-start-recording {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-start-recording:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }
        
        .btn-start-recording:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-stop-recording {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            display: none;
        }
        
        .btn-stop-recording:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.6);
        }
        
        .btn-icon {
            font-size: 1.5em;
        }
        
        .prescription-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .ai-recommendations {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            min-height: 150px;
        }
        
        .ai-recommendations h3 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-recommendations-content {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 30px;
        }
        
        .manual-search {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn-search {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-search:hover {
            transform: translateY(-2px);
        }
        
        .prescription-area {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            resize: vertical;
        }
        
        .prescription-area:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üè• Patient Appointment</h1>
                <p>Consultation Management Interface</p>
            </div>
            <a href="/" class="back-link">Back to Dashboard</a>
        </div>
        
        <div class="content">
            <div class="layout">
                <!-- Left Column: Patient Information -->
                <div class="patient-info-section">
                    <h2 class="section-title">üë§ Patient Information</h2>
                    
                    <div class="patient-detail">
                        <label>Full Name</label>
                        <div class="patient-detail-value" id="patient-name">{{ patient.full_name }}</div>
                    </div>
                    
                    <div class="patient-detail">
                        <label>Patient ID</label>
                        <div class="patient-detail-value">{{ patient.patient_id }}</div>
                    </div>
                    
                    {% if patient.date_of_birth %}
                    <div class="patient-detail">
                        <label>Date of Birth</label>
                        <div class="patient-detail-value" id="patient-dob">{{ patient.date_of_birth }}</div>
                    </div>
                    {% else %}
                    <div class="patient-detail">
                        <label>Date of Birth</label>
                        <div class="patient-detail-value" id="patient-dob" style="color: #999; font-style: italic;">Not provided</div>
                    </div>
                    {% endif %}
                    
                    {% if patient.contact_info %}
                    <div class="patient-detail">
                        <label>Contact Information</label>
                        <div class="patient-detail-value" id="patient-contact">{{ patient.contact_info }}</div>
                    </div>
                    {% else %}
                    <div class="patient-detail">
                        <label>Contact Information</label>
                        <div class="patient-detail-value" id="patient-contact" style="color: #999; font-style: italic;">Not provided</div>
                    </div>
                    {% endif %}
                    
                    <button 
                        id="btn-edit-patient" 
                        style="margin-top: 15px; width: 100%; padding: 12px; background: #ffc107; color: #333; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.2s;"
                        onmouseover="this.style.transform='translateY(-2px)'"
                        onmouseout="this.style.transform='translateY(0)'"
                    >
                        ‚úèÔ∏è Edit Patient Info
                    </button>
                    
                    <div class="ehr-data-section">
                        <h3>üìã Current EHR Data</h3>
                        <div class="ehr-content">
                            {% if patient.ehr_data and patient.ehr_data != '{}' %}
                                <pre>{{ patient.ehr_data }}</pre>
                            {% else %}
                                <div class="ehr-empty">No EHR data recorded yet</div>
                            {% endif %}
                        </div>
                        <button 
                            id="btn-view-ehr" 
                            onclick="window.location.href='/ehr_report/{{ patient.patient_id }}'"
                            style="margin-top: 15px; width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.2s;"
                            onmouseover="this.style.transform='translateY(-2px)'"
                            onmouseout="this.style.transform='translateY(0)'"
                        >
                            üìã View Full EHR Report
                        </button>
                        <button 
                            id="btn-view-history" 
                            style="margin-top: 15px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: transform 0.2s;"
                            onmouseover="this.style.transform='translateY(-2px)'"
                            onmouseout="this.style.transform='translateY(0)'"
                        >
                            üìú View Consultation History
                        </button>
                    </div>
                </div>
                
                <!-- Right Column: Consultation & Prescription -->
                <div class="main-section">
                    <!-- Consultation Controls -->
                    <div class="card">
                        <h2 class="section-title">üéôÔ∏è Consultation Recording</h2>
                        
                        <div id="status-message" class="alert alert-info">
                            <strong>‚ÑπÔ∏è Status:</strong> <span id="recording-status">Ready to start consultation</span>
                        </div>
                        
                        <div class="consultation-controls">
                            <button 
                                id="btn-start-recording" 
                                class="recording-btn btn-start-recording" 
                                disabled
                            >
                                <span class="btn-icon">üé§</span>
                                <span>Start Recording</span>
                            </button>
                            
                            <button 
                                id="btn-stop-recording" 
                                class="recording-btn btn-stop-recording"
                            >
                                <span class="btn-icon">‚èπÔ∏è</span>
                                <span>Stop Recording & Process</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Prescription Pad -->
                    <div class="card prescription-section">
                        <h2 class="section-title">üíä Prescription</h2>
                        
                        <!-- AI Recommendations -->
                        <div class="ai-recommendations">
                            <h3>ü§ñ AI Recommendations</h3>
                            <div class="ai-recommendations-content" id="ai-recommendations">
                                AI recommendations will appear here after consultation recording is processed
                            </div>
                        </div>
                        
                        <!-- Manual Medicine Search -->
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">
                                üîç Search and Add Medicine Manually
                            </label>
                            <div class="manual-search">
                                <input 
                                    type="text" 
                                    class="search-input" 
                                    placeholder="Search for medicine by name..."
                                    id="medicine-search"
                                >
                                <button class="btn-search" id="btn-search-medicine">Search</button>
                            </div>
                            <div id="search-results" style="margin-top: 15px;"></div>
                        </div>
                        
                        <!-- Final Prescription Text Area -->
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">
                                üìù Final Prescription
                            </label>
                            <textarea 
                                class="prescription-area" 
                                placeholder="Final prescription list will appear here...&#10;&#10;You can also manually edit or add medications here."
                                id="prescription-text"
                            ></textarea>
                            <button 
                                id="btn-save-prescription" 
                                style="margin-top: 15px; width: 100%; padding: 15px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: transform 0.2s;"
                                onmouseover="this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.transform='translateY(0)'"
                            >
                                üíæ Save Prescription
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Track current consultation ID (set when consultation is processed)
        let currentConsultationId = null;
        
        // Patient data validation and button enablement
        document.addEventListener('DOMContentLoaded', function() {
            // Get patient name element
            const patientNameElement = document.getElementById('patient-name');
            const startRecordingBtn = document.getElementById('btn-start-recording');
            const recordingStatus = document.getElementById('recording-status');
            
            // Check if patient name is present
            if (patientNameElement && patientNameElement.textContent.trim() !== '') {
                // Patient info is valid, enable the Start Recording button
                startRecordingBtn.disabled = false;
                startRecordingBtn.style.cursor = 'pointer';
                recordingStatus.textContent = 'System ready - Click "Start Recording" to begin consultation';
                recordingStatus.parentElement.classList.remove('alert-info');
                recordingStatus.parentElement.classList.add('alert', 'alert-info');
                
                console.log('‚úì Patient information validated');
                console.log('‚úì Start Recording button enabled');
            } else {
                // No valid patient info
                startRecordingBtn.disabled = true;
                recordingStatus.textContent = 'Patient information incomplete - Cannot start recording';
                console.warn('‚ö†Ô∏è Patient information missing or incomplete');
            }
            
            // Medicine search functionality
            const searchBtn = document.getElementById('btn-search-medicine');
            const searchInput = document.getElementById('medicine-search');
            const searchResults = document.getElementById('search-results');
            
            // Search on button click
            searchBtn.addEventListener('click', async function() {
                await searchMedicines();
            });
            
            // Search on Enter key
            searchInput.addEventListener('keypress', async function(e) {
                if (e.key === 'Enter') {
                    await searchMedicines();
                }
            });
            
            async function searchMedicines() {
                const searchTerm = searchInput.value.trim();
                
                if (!searchTerm) {
                    alert('Please enter a medicine name to search');
                    return;
                }
                
                searchResults.innerHTML = '<div style="text-align: center; padding: 15px; color: #666;">üîç Searching...</div>';
                
                try {
                    const response = await fetch('/search_medicine', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ search_term: searchTerm })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success && result.medicines.length > 0) {
                        displaySearchResults(result.medicines);
                    } else if (result.success && result.medicines.length === 0) {
                        searchResults.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #999; font-style: italic;">
                                No medicines found matching "${searchTerm}"
                            </div>
                        `;
                    } else {
                        throw new Error(result.error || 'Search failed');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    searchResults.innerHTML = `
                        <div style="text-align: center; padding: 15px; color: #dc3545;">
                            ‚ùå Error: ${error.message}
                        </div>
                    `;
                }
            }
            
            function displaySearchResults(medicines) {
                let html = '<div style="background: #f9f9f9; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">';
                html += `<div style="font-weight: bold; margin-bottom: 10px; color: #667eea;">Found ${medicines.length} medicine(s):</div>`;
                
                medicines.forEach((med, index) => {
                    const stockWarning = med.stock_level < 10 ? ' ‚ö†Ô∏è Low Stock' : '';
                    const stockColor = med.stock_level < 10 ? '#dc3545' : '#28a745';
                    
                    html += `
                        <div style="background: white; border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <strong style="color: #333;">${med.name}</strong>
                                <span style="color: ${stockColor}; font-size: 0.85em; font-weight: bold;">
                                    Stock: ${med.stock_level}${stockWarning}
                                </span>
                            </div>
                            <div style="color: #666; font-size: 0.9em; margin-bottom: 8px;">
                                ${med.description}
                            </div>
                            <button onclick="addToPrescription('${med.name.replace(/'/g, "\\'")}')" 
                                    style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                                ‚ûï Add to Prescription
                            </button>
                        </div>
                    `;
                });
                
                html += '</div>';
                searchResults.innerHTML = html;
            }
            
            // Save prescription functionality
            const savePrescriptionBtn = document.getElementById('btn-save-prescription');
            const prescriptionTextArea = document.getElementById('prescription-text');
            
            savePrescriptionBtn.addEventListener('click', async function() {
                const prescriptionText = prescriptionTextArea.value.trim();
                
                if (!prescriptionText) {
                    alert('Please add medicines to the prescription before saving');
                    return;
                }
                
                if (!confirm('Are you sure you want to save this prescription?')) {
                    return;
                }
                
                // Disable button and show loading
                savePrescriptionBtn.disabled = true;
                savePrescriptionBtn.innerHTML = '‚è≥ Saving...';
                
                try {
                    const response = await fetch(`/save_prescription/${patientId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            prescription: prescriptionText,
                            consultation_id: currentConsultationId  // Link to current consultation
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('‚úÖ Prescription saved successfully!');
                        console.log('Prescription saved and linked to consultation:', currentConsultationId);
                        
                        // Clear prescription text area
                        prescriptionTextArea.value = '';
                        
                        // Clear search results and AI recommendations
                        searchResults.innerHTML = '';
                        document.getElementById('ai-recommendations').innerHTML = 'AI recommendations will appear here after consultation recording is processed';
                        
                        // Clear consultation ID after saving
                        currentConsultationId = null;
                        
                    } else {
                        throw new Error(result.error || 'Failed to save prescription');
                    }
                } catch (error) {
                    console.error('Save error:', error);
                    alert('‚ùå Error saving prescription: ' + error.message);
                } finally {
                    // Re-enable button
                    savePrescriptionBtn.disabled = false;
                    savePrescriptionBtn.innerHTML = 'üíæ Save Prescription';
                }
            });
            
            // View consultation history functionality
            const viewHistoryBtn = document.getElementById('btn-view-history');
            
            viewHistoryBtn.addEventListener('click', async function() {
                // Disable button and show loading
                viewHistoryBtn.disabled = true;
                viewHistoryBtn.innerHTML = '‚è≥ Loading...';
                
                try {
                    const response = await fetch(`/consultation_history/${patientId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        displayConsultationHistory(result.consultations);
                    } else {
                        throw new Error(result.error || 'Failed to load consultation history');
                    }
                } catch (error) {
                    console.error('History error:', error);
                    alert('‚ùå Error loading consultation history: ' + error.message);
                } finally {
                    // Re-enable button
                    viewHistoryBtn.disabled = false;
                    viewHistoryBtn.innerHTML = 'üìú View Consultation History';
                }
            });
            
            function displayConsultationHistory(consultations) {
                if (!consultations || consultations.length === 0) {
                    alert('üìã No consultation history found for this patient');
                    return;
                }
                
                // Format date for tab display
                function formatTabDate(dateStr) {
                    const date = new Date(dateStr);
                    const day = date.getDate();
                    const month = date.toLocaleString('en-US', { month: 'short' });
                    return `${day} ${month}`;
                }
                
                // Create tabs HTML
                let tabsHtml = '<div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">';
                consultations.forEach((consultation, index) => {
                    const tabDate = formatTabDate(consultation.consultation_date);
                    const isActive = index === 0 ? 'active' : '';
                    tabsHtml += `
                        <button class="consultation-tab ${isActive}" data-index="${index}" 
                                style="padding: 10px 20px; background: ${index === 0 ? '#667eea' : '#e9ecef'}; 
                                color: ${index === 0 ? 'white' : '#333'}; border: none; border-radius: 8px; 
                                cursor: pointer; font-weight: bold; transition: all 0.3s;">
                            üìÖ ${tabDate}
                        </button>
                    `;
                });
                tabsHtml += '</div>';
                
                // Create content HTML
                let contentHtml = '<div id="consultation-content">';
                consultations.forEach((consultation, index) => {
                    const fullDate = new Date(consultation.consultation_date).toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const isActive = index === 0 ? '' : 'style="display: none;"';
                    
                    contentHtml += `
                        <div class="consultation-content-panel" data-index="${index}" ${isActive}>
                            <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                                <h3 style="color: #667eea; margin-top: 0;">üìÖ ${fullDate}</h3>
                                <p style="color: #666; font-size: 0.9em; margin: 5px 0;">
                                    <strong>Consultation ID:</strong> ${consultation.consultation_id}
                                </p>
                            </div>
                            
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                                <h4 style="color: #856404; margin-top: 0; display: flex; align-items: center; gap: 8px;">
                                    <span>üìù</span> Consultation Transcript
                                </h4>
                                <div style="background: white; border-radius: 6px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; line-height: 1.6; white-space: pre-wrap; color: #333;">
${consultation.transcript_text || 'No transcript available'}
                                </div>
                            </div>
                            
                            <div style="background: #d1ecf1; border-left: 4px solid #17a2b8; border-radius: 8px; padding: 20px;">
                                <h4 style="color: #0c5460; margin-top: 0; display: flex; align-items: center; gap: 8px;">
                                    <span>üíä</span> Prescriptions
                                </h4>
                    `;
                    
                    if (consultation.prescriptions && consultation.prescriptions.length > 0) {
                        contentHtml += '<div style="background: white; border-radius: 6px; padding: 15px;"><ul style="margin: 0; padding-left: 20px;">';
                        consultation.prescriptions.forEach(med => {
                            const medName = med.name || med.raw || med;
                            const medDesc = med.description || '';
                            const medScore = med.similarity_score || '';
                            
                            contentHtml += `
                                <li style="margin-bottom: 10px; color: #333;">
                                    <strong style="color: #667eea;">${medName}</strong>
                                    ${medDesc ? `<br><span style="font-size: 0.9em; color: #666;">${medDesc}</span>` : ''}
                                    ${medScore ? `<br><span style="font-size: 0.85em; color: #28a745;">Match: ${medScore}%</span>` : ''}
                                </li>
                            `;
                        });
                        contentHtml += '</ul></div>';
                    } else {
                        contentHtml += `
                            <div style="background: #fff3cd; border-radius: 6px; padding: 15px; text-align: center;">
                                <p style="color: #856404; margin: 0; font-style: italic;">
                                    ‚ö†Ô∏è Prescription not yet filled by doctor
                                </p>
                                <small style="color: #666; display: block; margin-top: 5px;">
                                    Doctor fills prescription after reviewing consultation
                                </small>
                            </div>
                        `;
                    }
                    
                    contentHtml += `
                            </div>
                        </div>
                    `;
                });
                contentHtml += '</div>';
                
                let html = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;" id="history-modal">
                        <div style="background: white; border-radius: 15px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #667eea; padding-bottom: 15px;">
                                <h2 style="margin: 0; color: #667eea;">üìã Consultation History (${consultations.length} sessions)</h2>
                                <button onclick="document.getElementById('history-modal').remove()" 
                                        style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    ‚úï Close
                                </button>
                            </div>
                            ${tabsHtml}
                            ${contentHtml}
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', html);
                
                // Add tab click handlers
                document.querySelectorAll('.consultation-tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        
                        // Update tab styles
                        document.querySelectorAll('.consultation-tab').forEach(t => {
                            t.style.background = '#e9ecef';
                            t.style.color = '#333';
                        });
                        this.style.background = '#667eea';
                        this.style.color = 'white';
                        
                        // Show corresponding content
                        document.querySelectorAll('.consultation-content-panel').forEach(panel => {
                            panel.style.display = 'none';
                        });
                        document.querySelector(`.consultation-content-panel[data-index="${index}"]`).style.display = 'block';
                    });
                });
            }
            
            // Global function to load prescription to textarea
            window.loadPrescriptionToTextarea = function(prescriptionText) {
                document.getElementById('prescription-text').value = prescriptionText;
                document.getElementById('history-modal').remove();
                alert('‚úÖ Prescription loaded to prescription pad');
            };
            
            // Edit patient information functionality
            const editPatientBtn = document.getElementById('btn-edit-patient');
            
            editPatientBtn.addEventListener('click', function() {
                const currentName = document.getElementById('patient-name').textContent;
                const currentDob = document.getElementById('patient-dob').textContent;
                const currentContact = document.getElementById('patient-contact').textContent;
                
                // Clean up "Not provided" text
                const dobValue = currentDob === 'Not provided' ? '' : currentDob;
                const contactValue = currentContact === 'Not provided' ? '' : currentContact;
                
                const html = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;" id="edit-modal">
                        <div style="background: white; border-radius: 15px; max-width: 600px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #667eea; padding-bottom: 15px;">
                                <h2 style="margin: 0; color: #667eea;">‚úèÔ∏è Edit Patient Information</h2>
                                <button onclick="document.getElementById('edit-modal').remove()" 
                                        style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                    ‚úï Close
                                </button>
                            </div>
                            <form id="edit-patient-form" style="display: flex; flex-direction: column; gap: 15px;">
                                <div>
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Full Name *</label>
                                    <input type="text" id="edit-name" value="${currentName}" required
                                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Date of Birth</label>
                                    <input type="date" id="edit-dob" value="${dobValue}"
                                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Gender</label>
                                    <select id="edit-gender" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Contact Information</label>
                                    <input type="text" id="edit-contact" value="${contactValue}" placeholder="Phone, email, etc."
                                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                </div>
                                <div>
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">Insurance Information</label>
                                    <input type="text" id="edit-insurance" placeholder="Insurance provider and policy number"
                                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                </div>
                                <button type="submit" 
                                        style="margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1em;">
                                    üíæ Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', html);
                
                // Add form submit handler
                document.getElementById('edit-patient-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const newName = document.getElementById('edit-name').value.trim();
                    const newDob = document.getElementById('edit-dob').value.trim();
                    const newGender = document.getElementById('edit-gender').value.trim();
                    const newContact = document.getElementById('edit-contact').value.trim();
                    const newInsurance = document.getElementById('edit-insurance').value.trim();
                    
                    if (!newName) {
                        alert('Patient name is required');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/update_patient/${patientId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                full_name: newName,
                                date_of_birth: newDob,
                                gender: newGender,
                                contact_info: newContact,
                                insurance_info: newInsurance
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('‚úÖ Patient information updated successfully! Please refresh the page to see changes.');
                            document.getElementById('edit-modal').remove();
                            // Refresh the page to show updated info
                            location.reload();
                        } else {
                            throw new Error(result.error || 'Failed to update patient');
                        }
                    } catch (error) {
                        console.error('Update error:', error);
                        alert('‚ùå Error updating patient: ' + error.message);
                    }
                });
            });
        });
    </script>
    
    <script>
        // Audio recording functionality
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        const patientId = "{{ patient.patient_id }}";
        
        // Get DOM elements
        const startBtn = document.getElementById('btn-start-recording');
        const stopBtn = document.getElementById('btn-stop-recording');
        const statusMessage = document.getElementById('recording-status');
        const aiRecommendations = document.getElementById('ai-recommendations');
        const prescriptionText = document.getElementById('prescription-text');
        
        // Start Recording
        startBtn.addEventListener('click', async function() {
            if (this.disabled) return;
            
            try {
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Initialize MediaRecorder
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    // Stop all audio tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Create audio blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // Upload and process
                    await uploadAndProcess(audioBlob);
                };
                
                // Start recording
                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                // Update UI
                startBtn.style.display = 'none';
                stopBtn.style.display = 'flex';
                statusMessage.textContent = 'üî¥ Recording in progress... Speak clearly about the patient\'s symptoms and condition';
                statusMessage.parentElement.style.background = '#fff3cd';
                statusMessage.parentElement.style.borderColor = '#ffc107';
                statusMessage.parentElement.style.color = '#856404';
                
                console.log('‚úì Recording started');
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('Error accessing microphone. Please ensure you have granted microphone permissions.');
                statusMessage.textContent = 'Error: Could not access microphone';
            }
        });
        
        // Stop Recording
        stopBtn.addEventListener('click', function() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                const recordingDuration = Math.round((Date.now() - recordingStartTime) / 1000);
                console.log(`Recording stopped. Duration: ${recordingDuration}s`);
                
                mediaRecorder.stop();
                
                // Update UI
                stopBtn.style.display = 'none';
                startBtn.style.display = 'flex';
                startBtn.disabled = true;
                statusMessage.textContent = '‚è≥ Processing audio... This may take a few moments';
                statusMessage.parentElement.style.background = '#d1ecf1';
                statusMessage.parentElement.style.borderColor = '#bee5eb';
                statusMessage.parentElement.style.color = '#0c5460';
            }
        });
        
        // Upload and Process Audio
        async function uploadAndProcess(audioBlob) {
            try {
                // Create FormData
                const formData = new FormData();
                formData.append('audio', audioBlob, `consultation_${patientId}.wav`);
                
                console.log('Uploading audio to server...');
                aiRecommendations.innerHTML = '<div style="text-align: center; padding: 20px;"><strong>üîÑ Processing...</strong><br>Transcribing audio and analyzing with AI...</div>';
                
                // Send to server
                const response = await fetch(`/process_consultation/${patientId}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úì Processing successful:', result);
                    
                    // Store consultation ID for linking prescription later
                    currentConsultationId = result.consultation_id;
                    console.log('‚úì Consultation ID stored:', currentConsultationId);
                    
                    // Update status
                    statusMessage.textContent = '‚úì Processing complete! AI recommendations generated';
                    statusMessage.parentElement.style.background = '#d4edda';
                    statusMessage.parentElement.style.borderColor = '#c3e6cb';
                    statusMessage.parentElement.style.color = '#155724';
                    
                    // Display recommendations
                    displayRecommendations(result.recommendations);
                    
                    // Re-enable recording button
                    startBtn.disabled = false;
                    
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Error processing consultation:', error);
                
                statusMessage.textContent = '‚ùå Error processing consultation: ' + error.message;
                statusMessage.parentElement.style.background = '#f8d7da';
                statusMessage.parentElement.style.borderColor = '#f5c6cb';
                statusMessage.parentElement.style.color = '#721c24';
                
                aiRecommendations.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #721c24;">
                        <strong>‚ùå Error</strong><br>
                        ${error.message}<br><br>
                        <small>Please try recording again or contact support if the problem persists.</small>
                    </div>
                `;
                
                // Re-enable recording button
                startBtn.disabled = false;
            }
        }
        
        // Display AI Recommendations
        function displayRecommendations(recommendations) {
            if (!recommendations || recommendations.length === 0) {
                aiRecommendations.innerHTML = '<div style="text-align: center; color: #666; font-style: italic;">No recommendations generated. Try describing symptoms in more detail.</div>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 15px;">';
            
            recommendations.forEach((med, index) => {
                const stockWarning = med.stock_level < 10 ? ' ‚ö†Ô∏è Low Stock' : '';
                const scoreColor = med.similarity_score >= 40 ? '#28a745' : 
                                 med.similarity_score >= 25 ? '#ffc107' : '#6c757d';
                
                html += `
                    <div style="background: white; border-radius: 8px; padding: 15px; border-left: 4px solid ${scoreColor};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div>
                                <strong style="font-size: 1.1em; color: #333;">${index + 1}. ${med.name}</strong>
                                ${stockWarning ? '<span style="color: #dc3545; font-size: 0.85em; margin-left: 10px;">' + stockWarning + '</span>' : ''}
                            </div>
                            <span style="background: ${scoreColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: bold;">
                                ${med.similarity_score}% match
                            </span>
                        </div>
                        <div style="color: #666; font-size: 0.9em; margin-bottom: 8px;">
                            ${med.description}
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button onclick="addToPrescription('${med.name}')" 
                                    style="background: #667eea; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">
                                ‚ûï Add to Prescription
                            </button>
                            <span style="color: #999; font-size: 0.85em; padding: 6px 0;">
                                Stock: ${med.stock_level} units
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            aiRecommendations.innerHTML = html;
            
            console.log(`‚úì Displayed ${recommendations.length} recommendations`);
        }
        
        // Add medicine to prescription text area
        function addToPrescription(medicineName) {
            const currentText = prescriptionText.value;
            const newMedicine = `${medicineName}\n`;
            
            // Check if medicine is already in prescription
            if (currentText.includes(medicineName)) {
                alert(`${medicineName} is already in the prescription.`);
                return;
            }
            
            prescriptionText.value = currentText + newMedicine;
            console.log(`Added ${medicineName} to prescription`);
            
            // Visual feedback
            prescriptionText.style.borderColor = '#28a745';
            setTimeout(() => {
                prescriptionText.style.borderColor = '#e0e0e0';
            }, 500);
        }
    </script>
</body>
</html>

