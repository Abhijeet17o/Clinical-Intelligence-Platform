{% extends "base.html" %}

{% block title %}Prescription - {{ patient_name }}{% endblock %}

{% block extra_css %}
<style>
    .recommendation-card {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s;
    }

    .recommendation-card:hover {
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
    }

    .recommendation-card.selected {
        border-color: #28a745;
        background: #f8fff9;
    }

    .similarity-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
    }

    .similarity-fill {
        height: 100%;
        background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%);
        transition: width 0.3s;
    }

    .patient-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .patient-info h4 {
        color: #495057;
        margin-bottom: 10px;
    }

    .patient-info p {
        margin: 5px 0;
        color: #6c757d;
    }

    .transcript-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        margin: 15px 0;
        font-style: italic;
        color: #495057;
    }

    .quantity-input {
        width: 80px;
        padding: 8px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 16px;
    }

    .medicine-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="patient-info">
    <h4>üë§ Patient Information</h4>
    <p><strong>Patient ID:</strong> {{ patient_id }}</p>
    <p><strong>Name:</strong> {{ patient_name }}</p>
    <p><strong>Age:</strong> {{ patient_age }}</p>
    <p><strong>Doctor ID:</strong> {{ doctor_id }}</p>
    <p><strong>Session:</strong> {{ session_id }}</p>
    <p><strong>Timestamp:</strong> {{ timestamp }}</p>
</div>

<div class="card">
    <h3>üí¨ Conversation Transcript</h3>
    <div class="transcript-box">
        "{{ transcript }}"
    </div>
</div>

{% if ehr_data %}
<div class="card">
    <h3>üè• EHR Profile</h3>
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
        {% if ehr_data.symptoms %}
            <p><strong>Symptoms:</strong> {{ ehr_data.symptoms }}</p>
        {% endif %}
        {% if ehr_data.allergies_mentioned %}
            <p><strong>Allergies:</strong> {{ ehr_data.allergies_mentioned }}</p>
        {% endif %}
        {% if ehr_data.lifestyle_notes %}
            <p><strong>Lifestyle:</strong> {{ ehr_data.lifestyle_notes }}</p>
        {% endif %}
        {% if not ehr_data.symptoms and not ehr_data.allergies_mentioned and not ehr_data.lifestyle_notes %}
            <p style="color: #6c757d;"><em>No EHR data extracted</em></p>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="card">
    <h3>ü§ñ AI-Recommended Medicines</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">
        Based on semantic analysis of patient symptoms. Select medicines to include in prescription.
    </p>

    <form id="prescriptionForm" method="POST" action="/finalize_prescription">
        <input type="hidden" name="session_id" value="{{ session_id }}">
        <input type="hidden" name="patient_id" value="{{ patient_id }}">
        <input type="hidden" name="doctor_id" value="{{ doctor_id }}">

        {% if recommendations %}
            {% for med in recommendations %}
            <div class="recommendation-card" id="card-{{ loop.index }}">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="checkbox" 
                           class="medicine-checkbox" 
                           name="medicines[]" 
                           value="{{ med.name }}"
                           id="med-{{ loop.index }}"
                           onchange="toggleCard({{ loop.index }})">
                    
                    <div style="flex-grow: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <label for="med-{{ loop.index }}" style="cursor: pointer; font-size: 1.2em; font-weight: 600; color: #495057;">
                                #{{ loop.index }}. {{ med.name }}
                            </label>
                            <span class="badge badge-info">{{ "%.1f"|format(med.similarity_score) }}% Match</span>
                        </div>
                        
                        <p style="color: #6c757d; margin: 8px 0;">{{ med.description }}</p>
                        
                        <div style="display: flex; gap: 20px; margin-top: 10px;">
                            <span style="color: #6c757d;">
                                üì¶ Stock: <strong {% if med.low_stock %}style="color: #dc3545;"{% endif %}>{{ med.stock_level }}</strong>
                                {% if med.low_stock %}<span class="badge badge-danger">LOW</span>{% endif %}
                            </span>
                            <span style="color: #6c757d;">
                                üìä Prescribed: <strong>{{ med.prescription_frequency }}</strong> times
                            </span>
                        </div>

                        <div class="similarity-bar">
                            <div class="similarity-fill" style="width: {{ med.similarity_score }}%;"></div>
                        </div>

                        <div style="margin-top: 10px; display: none;" id="quantity-{{ loop.index }}">
                            <label style="color: #495057; font-weight: 600;">Quantity:</label>
                            <input type="number" 
                                   class="quantity-input" 
                                   name="quantities[]" 
                                   value="1" 
                                   min="1" 
                                   max="{{ med.stock_level }}">
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-warning">
                No recommendations available. Please check the transcript and database.
            </div>
        {% endif %}

        <div class="card" style="background: #f8f9fa;">
            <h4>üìù Additional Notes</h4>
            <textarea name="notes" 
                      rows="4" 
                      style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-family: inherit; font-size: 14px;"
                      placeholder="Add any special instructions, dosage notes, or warnings..."></textarea>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 20px;">
            <button type="submit" class="btn btn-success" style="flex-grow: 1;">
                ‚úÖ Finalize Prescription
            </button>
            <a href="/" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleCard(index) {
    const checkbox = document.getElementById('med-' + index);
    const card = document.getElementById('card-' + index);
    const quantityDiv = document.getElementById('quantity-' + index);
    
    if (checkbox.checked) {
        card.classList.add('selected');
        quantityDiv.style.display = 'block';
    } else {
        card.classList.remove('selected');
        quantityDiv.style.display = 'none';
    }
}

document.getElementById('prescriptionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const selectedCount = formData.getAll('medicines[]').length;
    
    if (selectedCount === 0) {
        alert('‚ö†Ô∏è Please select at least one medicine!');
        return;
    }
    
    if (!confirm(`Finalize prescription with ${selectedCount} medicine(s)?`)) {
        return;
    }
    
    fetch('/finalize_prescription', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message + '\n\nMedicines prescribed: ' + data.medicines_count);
            window.location.href = '/';
        } else {
            alert('‚ùå Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('‚ùå Error: ' + error.message);
    });
});
</script>
{% endblock %}
